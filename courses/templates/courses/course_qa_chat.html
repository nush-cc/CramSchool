{% extends 'base.html' %}

{% block title %}AI å•ç­” - {{ course.title }} - CramSchool{% endblock %}

{% block page_header %}
    <div class="page-header mb-0 pb-3 border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title mb-2">
                    <i class="bi bi-chat-dots text-info"></i> AI å•ç­”åŠ©æ‰‹
                </h1>
                <p class="page-subtitle mb-0">{{ course.title }} - {{ course.grade }}</p>
            </div>
            <div>
                <a href="{% url 'courses:course_detail' course.pk %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> çµæŸå•ç­”
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="chat-container-wrapper">
        <div class="row g-3">
            <div class="col-lg-9">
                <div class="card chat-card shadow-lg">
                    <div class="card-body chat-messages" id="chatMessages">
                        <div class="message-wrapper ai-message">
                            <div class="message-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">AI åŠ©æ•™</span>
                                    <span class="message-time">å‰›å‰›</span>
                                </div>
                                <div class="message-bubble ai">
                                    <p class="mb-2">ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å­¸ç¿’åŠ©æ•™ã€‚</p>
                                    <p class="mb-0">æˆ‘å¯ä»¥å¹«ä½ è§£ç­”é—œæ–¼ã€Œ{{ course.title }}ã€çš„ä»»ä½•å•é¡Œã€‚è«‹éš¨æ™‚å‘æˆ‘æå•ï¼</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer chat-input-area">
                        <form id="chatForm" class="d-flex gap-2 align-items-end" onsubmit="return false;">
                            <div class="flex-grow-1">
                            <textarea class="form-control chat-input" id="messageInput" rows="1"
                                      placeholder="è¼¸å…¥ä½ çš„å•é¡Œ... (Enter ç™¼é€ï¼ŒShift+Enter æ›è¡Œ)" required></textarea>
                            </div>
                            <button type="button" class="btn btn-primary btn-send" id="sendButton">
                                <i class="bi bi-send-fill"></i>
                                <span class="ms-2 d-none d-sm-inline">ç™¼é€</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-3">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle"></i> ç¯„ä¾‹é¡Œç›®
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary quick-question-btn"
                                    data-question="è«‹çµ¦æˆ‘ä¸€å€‹åŸºç¤é¡Œç›®ä¾†ç·´ç¿’"
                                    data-search-type="exercise">
                                <i class="bi bi-1-circle"></i> åŸºç¤é¡Œç›®
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question-btn"
                                    data-question="è«‹çµ¦æˆ‘ä¸€å€‹é€²éšé¡Œç›®ä¾†æŒ‘æˆ°"
                                    data-search-type="exercise">
                                <i class="bi bi-2-circle"></i> é€²éšé¡Œç›®
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question-btn"
                                    data-question="è«‹çµ¦æˆ‘ä¸€å€‹æ‡‰ç”¨é¡Œä¾†ç·´ç¿’"
                                    data-search-type="exercise">
                                <i class="bi bi-3-circle"></i> æ‡‰ç”¨é¡Œç›®
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-question-btn"
                                    data-question="è«‹çµ¦æˆ‘ä¸€å€‹ç¶œåˆé¡Œç›®"
                                    data-search-type="exercise">
                                <i class="bi bi-star"></i> ç¶œåˆé¡Œç›®
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-speedometer2"></i> ä½ çš„å­¸ç¿’ç­‰ç´š
                        </h6>
                    </div>
                    <div class="card-body text-center p-3">
                        <div class="level-badge-display mb-2">
                        <span class="badge badge-level-{{ user_level_code }} fs-6">
                            {{ user_level_display }}
                        </span>
                        </div>
                        <small class="text-muted d-block">
                            AI æœƒæ ¹æ“šä½ çš„ç­‰ç´šèª¿æ•´è§£é‡‹æ–¹å¼
                        </small>
                        <hr class="my-2">
                        <small class="text-muted d-block">
                            <i class="bi bi-info-circle"></i> å¦‚æœä¸æ‡‚ï¼Œå¯ä»¥é»æ“Šå›ç­”ä¸‹æ–¹çš„ã€Œæˆ‘é‚„æ˜¯ä¸æ‡‚ã€æŒ‰éˆ•ï¼ŒAI æœƒé™ä½é›£åº¦é‡æ–°è§£é‡‹
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_css %}
    <style>
        /* èŠå¤©å®¹å™¨ */
        .chat-container-wrapper {
            padding: 0;
        }

        .chat-card {
            height: 650px;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            overflow: hidden;
        }

        /* èŠå¤©è¨Šæ¯å€åŸŸ - å›ºå®šé«˜åº¦ä¸¦å¯æ»¾å‹• */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2rem;
            background: linear-gradient(to bottom, #f8f9fa 0%, #ffffff 100%);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-height: 0;
            /* é‡è¦ï¼šç¢ºä¿å¯ä»¥æ»¾å‹• */
        }

        /* è¨Šæ¯åŒ…è£å™¨ */
        .message-wrapper {
            display: flex;
            gap: 0.75rem;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-wrapper.user-message {
            flex-direction: row-reverse;
        }

        /* è¨Šæ¯é ­åƒ */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .ai-message .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-message .message-avatar {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
        }

        /* è¨Šæ¯å…§å®¹ */
        .message-content {
            flex: 1;
            max-width: 75%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .message-sender {
            font-weight: 600;
            color: #374151;
        }

        .message-time {
            color: #9ca3af;
            font-size: 0.75rem;
        }

        /* è¨Šæ¯æ°£æ³¡ */
        .message-bubble {
            padding: 1rem 1.25rem;
            border-radius: 1rem;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            white-space: pre-line;
        }

        .message-bubble.ai {
            background: white;
            border: 1px solid #e5e7eb;
        }

        .message-bubble.user {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .user-message .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        /* è¼¸å…¥å€åŸŸ */
        .chat-input-area {
            background: white;
            border-top: 2px solid #e5e7eb;
            padding: 1.5rem;
        }

        .chat-input {
            resize: none;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.3s;
            max-height: 120px;
        }

        .chat-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-send {
            border-radius: 1rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* å¿«é€Ÿæ“ä½œæŒ‰éˆ• */
        .quick-question-btn,
        .feedback-btn {
            text-align: left;
            font-size: 0.875rem;
            padding: 0.6rem 0.8rem;
            transition: all 0.3s;
            border-radius: 0.5rem;
        }

        .quick-question-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .feedback-btn:hover {
            transform: translateX(5px);
        }

        .btn-outline-success:hover {
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3);
        }

        .btn-outline-warning:hover {
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .btn-outline-danger:hover {
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        /* ç­‰ç´šå¾½ç« æ¨£å¼ */
        .badge-level-advanced {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .badge-level-standard {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .badge-level-basic {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        /* è¨Šæ¯åé¥‹æŒ‰éˆ•æ¨£å¼ */
        .message-feedback {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }

        .message-feedback .feedback-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .message-feedback .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
        }

        .level-indicator {
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* è¼‰å…¥å‹•ç•« */
        .typing-indicator {
            display: flex;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typingAnimation 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-10px);
            }
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 991px) {
            .chat-card {
                height: 500px;
            }

            .chat-messages {
                padding: 1rem;
            }

            .message-content {
                max-width: 85%;
            }

            .chat-input-area {
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            .chat-card {
                height: 400px;
            }
        }

        /* ç¢ºä¿èŠå¤©å®¹å™¨ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 60px);
            /* æ¸›å» navbar é«˜åº¦ */
        }

        .chat-container-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .chat-container-wrapper .row {
            flex: 1;
            margin: 0;
        }

        .chat-card {
            height: calc(100vh - 60px - 4rem - 100px);
            /* navbar + padding + å…¶ä»–å…ƒç´  */
            min-height: 500px;
            max-height: calc(100vh - 200px);
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 991px) {
            .chat-card {
                height: calc(100vh - 60px - 3rem - 100px);
                min-height: 450px;
            }
        }

        @media (max-width: 768px) {
            .chat-card {
                height: calc(100vh - 60px - 2rem - 100px);
                min-height: 400px;
            }
        }

        /* Markdown å…§å®¹æ¨£å¼ */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content p {
            margin-bottom: 0.5rem;
        }

        .markdown-content p:last-child {
            margin-bottom: 0;
        }

        .markdown-content strong {
            font-weight: 700;
            color: #1e293b;
        }

        .markdown-content em {
            font-style: italic;
            color: #475569;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        .markdown-content code {
            background-color: #f1f5f9;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            color: #e11d48;
        }

        .markdown-content pre {
            background-color: #1e293b;
            color: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 0.5rem;
        }

        .markdown-content pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content blockquote {
            border-left: 3px solid #cbd5e1;
            padding-left: 1rem;
            margin: 0.5rem 0;
            color: #64748b;
            font-style: italic;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e2e8f0;
            margin: 1rem 0;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
        }

        .markdown-content table th {
            background-color: #f8fafc;
            font-weight: 600;
        }

        /* æ•¸å­¸ä½”ä½ç¬¦æ¨£å¼ï¼ˆç•¶åŸå§‹å…¬å¼éºå¤±æ™‚é¡¯ç¤ºï¼‰ */
        .math-placeholder {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.9em;
            border: 1px dashed #fbbf24;
            cursor: help;
        }

        .math-placeholder:hover {
            background-color: #fde68a;
        }

        /* å¤–éƒ¨é€£çµå¡ç‰‡æ¨£å¼ */
        .simulation-container {
            border-left: 4px solid #0dcaf0;
            /* Info color */
            background-color: #f0faff;
            transition: transform 0.2s;
        }

        .simulation-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
{% endblock %}

{% block extra_js %}
    <script>
        // MathJax é…ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const quickQuestionBtns = document.querySelectorAll('.quick-question-btn');
        const feedbackBtns = document.querySelectorAll('.feedback-btn');

        // é…ç½® Marked.js
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,  // æ”¯æ´æ›è¡Œ
                gfm: true,     // GitHub Flavored Markdown
                headerIds: false,
                mangle: false
            });
        }

        // Markdown æ¸²æŸ“å‡½æ•¸ï¼ˆä¿è­· LaTeX å…¬å¼ï¼‰
        function renderMarkdown(text) {
            if (!text) return '';

            // âš ï¸ é‡è¦ï¼šå…ˆè™•ç†ä¾†è‡ªå¾Œç«¯çš„ MATH_ ä½”ä½ç¬¦ï¼ˆPDF æå–æ™‚ç”¢ç”Ÿçš„ï¼‰
            // å°‡å®ƒå€‘æ›¿æ›ç‚ºæ›´å‹å¥½çš„æ–‡å­—ï¼Œé¿å…èˆ‡æˆ‘å€‘è‡ªå·±çš„ä½”ä½ç¬¦è¡çª
            text = text.replace(/MATH_INLINE_(\d+)/g, '<span class="math-placeholder" title="åŸå§‹æ•¸å­¸å…¬å¼éºå¤±">[å…¬å¼$1]</span>');
            text = text.replace(/MATH_BLOCK_(\d+)/g, '<div class="math-placeholder" title="åŸå§‹æ•¸å­¸å…¬å¼éºå¤±">[æ•¸å­¸å€å¡Š$1]</div>');

            // ä¹Ÿè™•ç†æ²’æœ‰åº•ç·šçš„ç‰ˆæœ¬
            text = text.replace(/MATH_INLINE(\d+)/g, '<span class="math-placeholder" title="åŸå§‹æ•¸å­¸å…¬å¼éºå¤±">[å…¬å¼$1]</span>');
            text = text.replace(/MATH_BLOCK(\d+)/g, '<div class="math-placeholder" title="åŸå§‹æ•¸å­¸å…¬å¼éºå¤±">[æ•¸å­¸å€å¡Š$1]</div>');

            // 1. ä¿è­·çœŸæ­£çš„ LaTeX å…¬å¼ï¼Œä½¿ç”¨ä¸æœƒè¡çªçš„ä½”ä½ç¬¦å‰ç¶´
            const mathPlaceholders = {};
            let placeholderCounter = 0;
            let protectedText = text;

            // ä¿è­· display math: \[...\] å’Œ $$...$$
            protectedText = protectedText.replace(/(\\\[[\s\S]*?\\\]|\$\$[\s\S]*?\$\$)/g, (match) => {
                const placeholder = `XPROTECTEDXDISPLAYXMATHX${placeholderCounter}X`;
                mathPlaceholders[placeholder] = match;
                placeholderCounter++;
                return placeholder;
            });

            // ä¿è­· inline math: \(...\) å’Œ $...$
            protectedText = protectedText.replace(/(\\\([\s\S]*?\\\)|\$[^\$\n]+?\$)/g, (match) => {
                const placeholder = `XPROTECTEDXINLINEXMATHX${placeholderCounter}X`;
                mathPlaceholders[placeholder] = match;
                placeholderCounter++;
                return placeholder;
            });

            // 2. ä½¿ç”¨ Marked æ¸²æŸ“ Markdown
            let rendered = marked.parse(protectedText);

            // 3. é‚„åŸçœŸæ­£çš„ LaTeX å…¬å¼ - ä½¿ç”¨ç°¡å–®çš„å­—ç¬¦ä¸²æ›¿æ›
            for (const [placeholder, original] of Object.entries(mathPlaceholders)) {
                // ä½¿ç”¨ split-join æ–¹å¼æ›¿æ›æ‰€æœ‰å‡ºç¾çš„ä½”ä½ç¬¦
                rendered = rendered.split(placeholder).join(original);
            }

            return rendered;
        }

        // å°è©±æ­·å²ç®¡ç†ï¼ˆä½¿ç”¨ sessionStorageï¼Œé‡æ•´é é¢å°±æ¸…ç©ºï¼‰
        let conversationHistory = JSON.parse(sessionStorage.getItem('chatHistory_{{ course.pk }}')) || [];

        // ç•¶å‰å•é¡Œå’Œç­”æ¡ˆï¼ˆç”¨æ–¼æ·±å…¥è¿½å•ï¼‰
        let currentQuestion = '';
        let currentAnswer = '';
        let currentSegments = [];
        let currentSearchType = 'teaching';  // è¿½è¹¤ç•¶å‰æœå°‹é¡å‹
        let currentExerciseQuestion = '';  // ç·´ç¿’é¡Œæ¨¡å¼ï¼šå„²å­˜é¡Œç›®
        let currentExerciseAnswer = '';    // ç·´ç¿’é¡Œæ¨¡å¼ï¼šå„²å­˜ç­”æ¡ˆ

        // é›£åº¦ç­‰ç´šç®¡ç†
        let currentResponseLevel = '{{ user_level_code }}';  // å¾å¾Œç«¯å–å¾—ä½¿ç”¨è€…ç­‰ç´š (advanced/standard/basic)
        let retryCount = 0;  // é‡è©¦æ¬¡æ•¸

        // é›£åº¦ç­‰ç´šæ˜ å°„
        const LEVEL_DOWNGRADE = {
            'advanced': 'standard',
            'standard': 'basic',
            'basic': 'basic'  // åŸºç¤ç´šä¿æŒä¸è®Šï¼Œä½†æœƒæ›è§’åº¦
        };

        const LEVEL_DISPLAY_NAMES = {
            'advanced': 'é€²éšç´š',
            'standard': 'æ¨™æº–ç´š',
            'basic': 'åŸºç¤ç´š'
        };

        // ç²å– CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // è‡ªå‹•èª¿æ•´ textarea é«˜åº¦
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // ç™¼é€è¨Šæ¯çš„é€šç”¨è™•ç†å‡½æ•¸
        function handleSendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // è¡¨å–®æäº¤äº‹ä»¶ï¼ˆé˜²æ­¢é è¨­è¡Œç‚ºï¼‰
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            handleSendMessage();
        });

        // ç™¼é€æŒ‰éˆ•é»æ“Šäº‹ä»¶
        sendButton.addEventListener('click', function (e) {
            e.preventDefault();
            handleSendMessage();
        });

        // å¿«é€Ÿæå•æŒ‰éˆ•
        quickQuestionBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const question = this.getAttribute('data-question');
                const searchType = this.getAttribute('data-search-type') || 'teaching';
                sendMessage(question, searchType);
            });
        });

        // ç™¼é€è¨Šæ¯å‡½æ•¸ï¼ˆå‘¼å«çœŸå¯¦ APIï¼‰
        function sendMessage(message, searchType = 'hybrid', isRetry = false, useAlternative = false, retryCountParam = 0) {
            // åªåœ¨éé‡è©¦æ™‚é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
            if (!isRetry) {
                addMessage(message, 'user');
            }

            // å„²å­˜ç•¶å‰å•é¡Œå’Œæœå°‹é¡å‹
            currentQuestion = message;
            currentSearchType = searchType;

            // ç¦ç”¨è¼¸å…¥
            sendButton.disabled = true;
            messageInput.disabled = true;

            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showTypingIndicator();

            // å‘¼å« Django API
            fetch("{% url 'courses:course_qa_api' course.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    message: message,
                    history: conversationHistory.slice(-10),  // æœ€è¿‘ 5 è¼ªï¼ˆ10 æ¢è¨Šæ¯ï¼‰
                    search_type: searchType,  // ä½¿ç”¨å‚³å…¥çš„ searchType åƒæ•¸
                    learner_style: LEVEL_DISPLAY_NAMES[currentResponseLevel],  // ç•¶å‰é›£åº¦
                    is_retry: isRetry,  // æ˜¯å¦ç‚ºé‡è©¦
                    retry_count: retryCountParam,  // é‡è©¦æ¬¡æ•¸
                    use_alternative: useAlternative  // æ˜¯å¦æ›è§’åº¦
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    removeTypingIndicator();

                    // å„²å­˜ç­”æ¡ˆå’Œåˆ†æ®µ
                    currentAnswer = data.answer;
                    currentSegments = data.segments || [];

                    // ====== [æ–°å¢] æª¢æŸ¥å¾Œç«¯æ˜¯å¦æœ‰å›å‚³ç•«åœ–è³‡æ–™ ======
                    let drawingHtml = null;
                    if (data.drawing_id && data.drawing_total_steps > 0) {
                        console.log("æ¥æ”¶åˆ°ç•«åœ–è³‡æ–™:", data.drawing_id, data.drawing_total_steps);
                        drawingHtml = createDrawingViewer(data.drawing_id, data.drawing_total_steps);
                    }
                    // ============================================

                    // ====== [æ–°å¢] æª¢æŸ¥å¾Œç«¯å¤–éƒ¨é€£çµè³‡æ–™ ======
                    let simulationHtml = null;
                    if (data.simulation_url) {
                        console.log("æ¥æ”¶åˆ°å¤–éƒ¨é€£çµ:", data.simulation_url);
                        simulationHtml = createSimulationCard(data.simulation_url);
                    }
                    // ============================================

                    // åˆ¤æ–·æ˜¯å¦ç‚ºç·´ç¿’é¡Œæ¨¡å¼
                    if (data.exercise_question && data.exercise_answer) {
                        // ç·´ç¿’é¡Œæ¨¡å¼ï¼šå„²å­˜é¡Œç›®å’Œç­”æ¡ˆ
                        currentExerciseQuestion = data.exercise_question;
                        currentExerciseAnswer = data.exercise_answer;

                        // é¡¯ç¤ºé¡Œç›®å’Œç­”æ¡ˆé®ç½©
                        addMessage('', 'ai', null, {
                            question: data.exercise_question,
                            answer: data.exercise_answer
                        }, drawingHtml, simulationHtml);
                    } else {
                        // ä¸€èˆ¬å°è©±æ¨¡å¼ï¼šæ¸…ç©ºç·´ç¿’é¡Œè³‡æ–™
                        currentExerciseQuestion = '';
                        currentExerciseAnswer = '';

                        // é¡¯ç¤ºåˆ†æ®µ
                        addMessage(data.answer, 'ai', data.segments, null, drawingHtml, simulationHtml);
                    }

                    // æ›´æ–°å°è©±æ­·å²
                    conversationHistory.push({role: 'user', content: message});
                    conversationHistory.push({role: 'assistant', content: data.answer});
                    sessionStorage.setItem('chatHistory_{{ course.pk }}', JSON.stringify(conversationHistory));

                    // å•Ÿç”¨è¼¸å…¥
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                })
                .catch(error => {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addMessage('æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message + '\n\nè«‹ç¢ºèª AI æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œã€‚', 'ai');

                    // å•Ÿç”¨è¼¸å…¥
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                });
        }

        // ç™¼é€ç†è§£ç¨‹åº¦å›é¥‹
        // é‡è©¦ï¼ˆé™ç´šæˆ–æ›è§’åº¦ï¼‰
        function retryWithLowerLevel(messageId) {
            // å–å¾—åŸå§‹å•é¡Œ
            const originalQuestion = currentQuestion;

            if (!originalQuestion) {
                alert('ç„¡æ³•æ‰¾åˆ°åŸå§‹å•é¡Œ');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºç·´ç¿’é¡Œæ¨¡å¼
            const isExerciseMode = (currentSearchType === 'exercise' && currentExerciseQuestion);

            // è¨ˆç®—æ–°çš„é›£åº¦ç­‰ç´š
            const nextLevel = LEVEL_DOWNGRADE[currentResponseLevel];
            const isDowngrade = nextLevel !== currentResponseLevel;

            if (!isDowngrade) {
                // åŸºç¤ç´šï¼šå¢åŠ é‡è©¦æ¬¡æ•¸ï¼Œç”¨æ–¼æç¤ºå¾Œç«¯æ›è§’åº¦
                retryCount++;
            } else {
                // é™ç´šï¼šé‡ç½®é‡è©¦æ¬¡æ•¸
                retryCount = 0;
            }

            // é¡¯ç¤ºæç¤ºè¨Šæ¯
            if (isExerciseMode) {
                // ç·´ç¿’é¡Œæ¨¡å¼ï¼šé¡¯ç¤ºæ›è§’åº¦è§£é‡‹çš„æç¤º
                if (isDowngrade) {
                    addMessage(`ğŸ”„ æ­£åœ¨ç”¨æ›´ç°¡å–®çš„æ–¹å¼é‡æ–°è§£é‡‹é€™é¡Œ... (${LEVEL_DISPLAY_NAMES[currentResponseLevel]} â†’ ${LEVEL_DISPLAY_NAMES[nextLevel]})`, 'system');
                } else {
                    addMessage(`ğŸ”„ æ›å€‹è§’åº¦é‡æ–°è§£é‡‹é€™é¡Œçš„è§£æ³•... (${LEVEL_DISPLAY_NAMES[currentResponseLevel]} - æ–¹æ³• ${retryCount + 1})`, 'system');
                }
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šé¡¯ç¤ºä¸€èˆ¬æç¤º
                if (isDowngrade) {
                    addMessage(`ğŸ”„ æ­£åœ¨ç”¨æ›´ç°¡å–®çš„æ–¹å¼é‡æ–°è§£é‡‹... (${LEVEL_DISPLAY_NAMES[currentResponseLevel]} â†’ ${LEVEL_DISPLAY_NAMES[nextLevel]})`, 'system');
                } else {
                    addMessage(`ğŸ”„ æ›å€‹è§’åº¦é‡æ–°è§£é‡‹... (${LEVEL_DISPLAY_NAMES[currentResponseLevel]} - æ–¹æ³• ${retryCount + 1})`, 'system');
                }
            }

            // æ›´æ–°ç•¶å‰é›£åº¦ç­‰ç´š
            currentResponseLevel = nextLevel;

            // æ ¹æ“šæ¨¡å¼æ±ºå®šé‡æ–°ç™¼é€çš„å…§å®¹
            if (isExerciseMode) {
                // ç·´ç¿’é¡Œæ¨¡å¼ï¼šæ§‹å»ºã€Œè«‹è§£é‡‹é€™é¡Œã€çš„å•é¡Œï¼Œä¸¦é™„ä¸Šé¡Œç›®å…§å®¹
                const explainQuestion = `è«‹ç”¨ä¸åŒçš„æ–¹æ³•è§£é‡‹é€™é¡Œçš„è§£æ³•ï¼š\n\n${currentExerciseQuestion}`;

                // ä½¿ç”¨ teaching æ¨¡å¼é‡æ–°ç™¼é€ï¼ˆå› ç‚ºæˆ‘å€‘è¦è§£é‡‹ï¼Œè€Œéå‡ºæ–°é¡Œï¼‰
                sendMessage(explainQuestion, 'teaching', true, !isDowngrade, retryCount);
            } else {
                // ä¸€èˆ¬æ¨¡å¼ï¼šé‡æ–°ç™¼é€åŸå§‹å•é¡Œï¼ˆä½¿ç”¨ hybrid æ¨¡å¼ï¼‰
                sendMessage(originalQuestion, 'hybrid', true, !isDowngrade, retryCount);
            }
        }

        // æ¨™è¨˜ç‚ºå·²ç†è§£
        function markAsUnderstood(messageId) {
            const feedbackDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (feedbackDiv) {
                feedbackDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle-fill"></i> å·²æ¨™è¨˜ç‚ºç†è§£</small>';
            }

            // æœªä¾†å¯ä»¥åŠ å…¥ï¼šç™¼é€åˆ°å¾Œç«¯è¨˜éŒ„ä½¿ç”¨è€…ç†è§£æƒ…æ³
        }

        // æ·»åŠ è¨Šæ¯åˆ°èŠå¤©è¦–çª—
        // [ä¿®æ”¹] å¢åŠ  simulationHtml åƒæ•¸
        function addMessage(text, sender, segments = null, exerciseData = null, drawingHtml = null, simulationHtml = null) {
            const messageWrapper = document.createElement('div');

            // ç³»çµ±è¨Šæ¯ä½¿ç”¨ç‰¹æ®Šæ¨£å¼
            if (sender === 'system') {
                messageWrapper.className = 'message-wrapper ai-message';
                messageWrapper.innerHTML = `
                <div class="message-avatar" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                    <i class="bi bi-info-circle"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #3b82f6; color: #1e40af;">
                        <div style="font-weight: 600;">${text}</div>
                    </div>
                </div>
            `;
                chatMessages.appendChild(messageWrapper);
                scrollToBottom();
                return;
            }

            messageWrapper.className = `message-wrapper ${sender}-message`;

            const currentTime = new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const avatarIcon = sender === 'ai' ? 'bi-robot' : 'bi-person-circle';
            const senderName = sender === 'ai' ? 'AI åŠ©æ•™' : 'ä½ ';
            const bubbleClass = sender === 'ai' ? 'ai' : 'user';

            let contentHTML = '';

            // ç·´ç¿’é¡Œæ¨¡å¼ï¼ˆæœ‰é¡Œç›®å’Œç­”æ¡ˆï¼‰
            if (sender === 'ai' && exerciseData && exerciseData.question && exerciseData.answer) {
                const answerId = `answer-${Date.now()}`;
                const buttonId = `btn-${Date.now()}`;
                // æ¸²æŸ“ Markdown
                const renderedQuestion = renderMarkdown(exerciseData.question);
                const renderedAnswer = renderMarkdown(exerciseData.answer);
                contentHTML = `
                <div class="message-bubble ${bubbleClass}">
                    <div class="exercise-question">
                        <h6 style="color: #0d6efd; margin-bottom: 12px;">
                            <i class="bi bi-pencil-square"></i> ç·´ç¿’é¡Œ
                        </h6>
                        <div class="markdown-content">${renderedQuestion}</div>
                    </div>
                    <div class="exercise-answer-section" style="margin-top: 16px;">
                        <button class="btn btn-outline-primary btn-sm" id="${buttonId}"
                                onclick="toggleAnswer('${answerId}', '${buttonId}')">
                            <i class="bi bi-eye"></i> é¡¯ç¤ºç­”æ¡ˆ
                        </button>
                        <div class="exercise-answer" id="${answerId}"
                                style="display: none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-left: 3px solid #28a745; border-radius: 4px;">
                            <h6 style="color: #28a745; margin-bottom: 8px;">
                                <i class="bi bi-check-circle"></i> ç­”æ¡ˆ
                            </h6>
                            <div class="markdown-content">${renderedAnswer}</div>
                        </div>
                    </div>
                </div>
            `;
            }
            // å¦‚æœæœ‰åˆ†æ®µï¼Œé¡¯ç¤ºå¯é»æ“Šçš„åˆ†æ®µï¼ˆä¸€èˆ¬å°è©±æ¨¡å¼ï¼‰
            else if (sender === 'ai' && segments && segments.length > 0) {
                const timestamp = Date.now(); // åœ¨å¤–å±¤ç”Ÿæˆä¸€æ¬¡æ™‚é–“æˆ³
                contentHTML = '<div class="message-bubble-segments">';
                segments.forEach((segment, index) => {
                    const segmentId = `segment-${timestamp}-${index}`;
                    // æ¸²æŸ“ Markdown
                    const renderedSegment = renderMarkdown(segment);
                    contentHTML += `
                    <div class="segment-item"
                            data-segment-index="${index}"
                            data-segment-text="${segment.replace(/"/g, '&quot;')}"
                            id="${segmentId}"
                            style="padding: 10px; margin: 8px 0; border-left: 3px solid #0d6efd; background: rgba(13, 110, 253, 0.05); border-radius: 4px; cursor: pointer; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(13, 110, 253, 0.1)'"
                            onmouseout="this.style.background='rgba(13, 110, 253, 0.05)'">
                        <div class="markdown-content">${renderedSegment}</div>
                        <small class="text-muted" style="display: block; margin-top: 8px;">
                            <i class="bi bi-hand-index"></i> é»æ“Šé€™æ®µæ–‡å­—å¯ä»¥æ·±å…¥äº†è§£
                        </small>
                    </div>
                `;
                });
                contentHTML += '</div>';
            } else {
                // ä¸€èˆ¬è¨Šæ¯
                const renderedText = sender === 'ai' ? renderMarkdown(text) : text;
                contentHTML = `
                <div class="message-bubble ${bubbleClass}">
                    <div class="markdown-content">${renderedText}</div>
                </div>
            `;
            }

            // ====== [æ–°å¢] ç•«åœ–èˆ‡å¤–éƒ¨é€£çµçš„æ¸²æŸ“ ======

            // 1. ç•«åœ–å€å¡Š
            if (drawingHtml) {
                contentHTML += `
                <div class="drawing-section mt-3">
                    ${drawingHtml}
                </div>
            `;
            }

            // 2. [æ–°å¢] å¤–éƒ¨é€£çµå€å¡Š
            if (simulationHtml) {
                contentHTML += `
                <div class="simulation-section">
                    ${simulationHtml}
                </div>
            `;
            }
            // ======================================

            // å¦‚æœæ˜¯ AI å›ç­”ï¼ŒåŠ å…¥åé¥‹æŒ‰éˆ•
            let feedbackHTML = '';
            if (sender === 'ai') {
                const messageId = `msg-${Date.now()}`;
                feedbackHTML = `
                <div class="message-feedback" data-message-id="${messageId}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="feedback-buttons">
                            <button class="btn btn-sm btn-outline-warning" onclick="retryWithLowerLevel('${messageId}')">
                                <i class="bi bi-lightbulb"></i> æˆ‘é‚„æ˜¯ä¸æ‡‚
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="markAsUnderstood('${messageId}')">
                                <i class="bi bi-hand-thumbs-up"></i> æˆ‘æ‡‚äº†
                            </button>
                        </div>
                        <small class="level-indicator">
                            <i class="bi bi-speedometer2"></i> ${LEVEL_DISPLAY_NAMES[currentResponseLevel]}
                        </small>
                    </div>
                </div>
            `;
            }

            messageWrapper.innerHTML = `
            <div class="message-avatar">
                <i class="bi ${avatarIcon}"></i>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-sender">${senderName}</span>
                    <span class="message-time">${currentTime}</span>
                </div>
                ${contentHTML}
                ${feedbackHTML}
            </div>
        `;

            chatMessages.appendChild(messageWrapper);

            // å¦‚æœæœ‰åˆ†æ®µï¼Œç‚ºæ¯å€‹åˆ†æ®µæ·»åŠ é»æ“Šäº‹ä»¶
            if (sender === 'ai' && segments && segments.length > 0) {
                // ç›´æ¥ä½¿ç”¨ class é¸æ“‡å™¨ä¾†ç¶å®šäº‹ä»¶ï¼Œä¸ä¾è³´ ID
                const segmentItems = messageWrapper.querySelectorAll('.segment-item');
                console.log('æ‰¾åˆ°çš„ segment æ•¸é‡:', segmentItems.length);
                segmentItems.forEach((segmentElement, idx) => {
                    console.log(`ç‚º segment ${idx} ç¶å®šé»æ“Šäº‹ä»¶`);
                    segmentElement.addEventListener('click', function (e) {
                        console.log('Segment è¢«é»æ“Šäº†ï¼');
                        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                        const segmentText = this.getAttribute('data-segment-text');
                        console.log('é¸ä¸­çš„æ–‡å­—:', segmentText ? segmentText.substring(0, 50) : 'null');
                        requestClarification(segmentText);
                    });
                });
            }

            // æ¸²æŸ“æ•¸å­¸å…¬å¼ï¼ˆMathJaxï¼‰
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([messageWrapper]).catch((err) => {
                    console.log('MathJax æ¸²æŸ“éŒ¯èª¤:', err);
                });
            }

            scrollToBottom();
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message-wrapper ai-message';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
        <div class="message-avatar">
            <i class="bi bi-robot"></i>
        </div>
        <div class="message-content">
            <div class="message-bubble ai">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>
    `;
            chatMessages.appendChild(indicator);
            scrollToBottom();
        }

        // ç§»é™¤è¼‰å…¥å‹•ç•«
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ»¾å‹•åˆ°åº•éƒ¨ï¼ˆå¹³æ»‘æ»¾å‹•ï¼‰
        function scrollToBottom() {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }

        // æ·±å…¥è¿½å•å‡½æ•¸
        function requestClarification(selectedText) {
            if (!selectedText || !currentQuestion) {
                console.error('ç¼ºå°‘å¿…è¦åƒæ•¸');
                return;
            }

            // é¡¯ç¤ºä½¿ç”¨è€…é¸æ“‡çš„ç‰‡æ®µ
            addMessage(`æˆ‘æƒ³æ·±å…¥äº†è§£ï¼šã€Œ${selectedText.substring(0, 100)}...ã€`, 'user');

            // ç¦ç”¨è¼¸å…¥
            sendButton.disabled = true;
            messageInput.disabled = true;

            // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
            showTypingIndicator();

            // å‘¼å«æ·±å…¥è¿½å• API
            fetch("{% url 'courses:course_qa_clarify' course.pk %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    selected_text: selectedText,
                    original_query: currentQuestion,
                    original_context: currentAnswer
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    removeTypingIndicator();

                    // é¡¯ç¤ºæ·±å…¥è§£é‡‹
                    addMessage(data.clarification, 'ai');

                    // å•Ÿç”¨è¼¸å…¥
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                })
                .catch(error => {
                    console.error('Error:', error);
                    removeTypingIndicator();
                    addMessage('æŠ±æ­‰ï¼Œç„¡æ³•ç²å–æ·±å…¥è§£é‡‹ï¼š' + error.message, 'ai');

                    // å•Ÿç”¨è¼¸å…¥
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                });
        }


        // --- ä¸­æ–‡è¼¸å…¥æ³•é˜²èª¤è§¸ä¿®æ­£é–‹å§‹ ---

        // 1. å®šç¾©ä¸€å€‹è®Šæ•¸ä¾†è¨˜éŒ„ã€Œæ˜¯ä¸æ˜¯æ­£åœ¨é¸å­—ã€
        let isComposing = false;

        // 2. ç›£è½ã€Œé–‹å§‹é¸å­—ã€ï¼šç•¶ä½ é–‹å§‹æ‰“æ³¨éŸ³/æ‹¼éŸ³æ™‚è§¸ç™¼
        messageInput.addEventListener('compositionstart', function () {
            isComposing = true;
        });

        // 3. ç›£è½ã€ŒçµæŸé¸å­—ã€ï¼šç•¶ä½ æŒ‰ä¸‹ Enter é¸å¥½å­—æ™‚è§¸ç™¼
        messageInput.addEventListener('compositionend', function () {
            isComposing = false;
        });

        // 4. ä¿®æ”¹åŸæœ¬çš„æŒ‰éµç›£è½
        messageInput.addEventListener('keydown', function (e) {
            // æª¢æŸ¥ï¼šå¦‚æœ (1) æ­£åœ¨é¸å­— æˆ– (2) ç€è¦½å™¨å›å‚³æ­£åœ¨çµ„å­—ä»£ç¢¼ (229)
            if (isComposing || e.isComposing || e.keyCode === 229) {
                return; // ç›´æ¥è·³å‡ºï¼Œä¸ç™¼é€ï¼
            }

            // åªæœ‰åœ¨ã€Œæ²’æŒ‰ Shiftã€ä¸”ã€ŒæŒ‰ä¸‹ Enterã€æ™‚æ‰ç™¼é€
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();  // é˜»æ­¢æ›è¡Œ
                handleSendMessage(); // åŸ·è¡Œç™¼é€
            }
        });
        // --- ä¸­æ–‡è¼¸å…¥æ³•é˜²èª¤è§¸ä¿®æ­£çµæŸ ---

        // åˆ‡æ›ç·´ç¿’é¡Œç­”æ¡ˆé¡¯ç¤º/éš±è—
        function toggleAnswer(answerId, buttonId) {
            const answerDiv = document.getElementById(answerId);
            const button = document.getElementById(buttonId);

            if (answerDiv.style.display === 'none') {
                // é¡¯ç¤ºç­”æ¡ˆ
                answerDiv.style.display = 'block';
                button.innerHTML = '<i class="bi bi-eye-slash"></i> éš±è—ç­”æ¡ˆ';
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-outline-secondary');
            } else {
                // éš±è—ç­”æ¡ˆ
                answerDiv.style.display = 'none';
                button.innerHTML = '<i class="bi bi-eye"></i> é¡¯ç¤ºç­”æ¡ˆ';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-primary');
            }
        }

        // é é¢è¼‰å…¥æ™‚æ»¾å‹•åˆ°åº•éƒ¨å’Œæ¸²æŸ“æ•¸å­¸å…¬å¼
        window.addEventListener('load', function () {
            scrollToBottom();

            // æ¸²æŸ“é é¢åˆå§‹è¼‰å…¥æ™‚çš„æ•¸å­¸å…¬å¼
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise().catch((err) => {
                    console.log('MathJax åˆå§‹æ¸²æŸ“éŒ¯èª¤:', err);
                });
            }
        });

        // ---------------------- ç•«åœ–åŠŸèƒ½é–‹å§‹ ----------------------

        // 1. ç”¢ç”Ÿç•«åœ–æ’­æ”¾å™¨çš„ HTML å­—ä¸²
        function createDrawingViewer(drawingId, totalSteps) {
            const viewerId = `viewer-${Date.now()}`;
            // é è¨­é¡¯ç¤ºç¬¬ 1 æ­¥
            // æ³¨æ„ï¼šé€™è£¡çš„ URL å¿…é ˆå°æ‡‰åˆ°ä½ åœ¨ Django urls.py è¨­å®šçš„è·¯å¾‘
            const firstStepUrl = `/courses/api/drawing/${drawingId}/1/`;

            return `
            <div class="drawing-container mt-3 p-3 border rounded bg-light" id="${viewerId}"
                data-id="${drawingId}" data-total="${totalSteps}" data-current="1">

                <h6 class="border-bottom pb-2 mb-3 text-primary">
                    <i class="bi bi-brush"></i> è§£é¡Œåœ–ç¤ºæ­¥é©Ÿ
                </h6>

                <div class="text-center bg-white p-2 mb-3 border rounded"
                    style="min-height: 300px; display:flex; align-items:center; justify-content:center;">
                    <img src="${firstStepUrl}" class="img-fluid step-image" alt="Step 1"
                        style="max-height: 350px; object-fit: contain;">
                </div>

                <div class="d-flex justify-content-between align-items-center bg-white p-2 rounded border">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeStep('${viewerId}', -1)" disabled>
                        <i class="bi bi-chevron-left"></i> ä¸Šä¸€æ­¥
                    </button>

                    <span class="step-counter badge bg-primary fs-6">æ­¥é©Ÿ 1 / ${totalSteps}</span>

                    <button class="btn btn-sm btn-primary" onclick="changeStep('${viewerId}', 1)">
                        ä¸‹ä¸€æ­¥ <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
        `;
        }

        // 2. è™•ç†æ­¥é©Ÿåˆ‡æ› (ç”± onclick è§¸ç™¼)
        function changeStep(viewerId, delta) {
            const container = document.getElementById(viewerId);
            if (!container) return;

            const img = container.querySelector('.step-image');
            const counter = container.querySelector('.step-counter');
            const prevBtn = container.querySelector('button:first-of-type');
            const nextBtn = container.querySelector('button:last-of-type');

            const drawingId = container.getAttribute('data-id');
            const total = parseInt(container.getAttribute('data-total'));
            let current = parseInt(container.getAttribute('data-current'));

            // è¨ˆç®—ä¸‹ä¸€æ­¥
            let nextStep = current + delta;

            // é˜²æ­¢è¶…å‡ºç¯„åœ
            if (nextStep < 1) nextStep = 1;
            if (nextStep > total) nextStep = total;

            // å¦‚æœæ­¥é©Ÿæ²’è®Šå°±ä¸åšå‹•ä½œ
            if (nextStep === current) return;

            // æ›´æ–°ç‹€æ…‹
            current = nextStep;
            container.setAttribute('data-current', current);

            // æ›´æ–°åœ–ç‰‡ä¾†æº (åŠ ä¸Š timestamp é˜²æ­¢ç€è¦½å™¨å¿«å–èˆŠåœ–)
            // å‘¼å« Django API: /courses/api/drawing/<id>/<step>/
            img.src = `/courses/api/drawing/${drawingId}/${current}/?t=${Date.now()}`;

            // æ›´æ–°è¨ˆæ•¸å™¨æ–‡å­—
            counter.textContent = `æ­¥é©Ÿ ${current} / ${total}`;

            // æ›´æ–°æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹
            prevBtn.disabled = (current <= 1);

            if (current >= total) {
                nextBtn.innerHTML = 'å®Œæˆ <i class="bi bi-check"></i>';
                nextBtn.classList.remove('btn-primary');
                nextBtn.classList.add('btn-success');
                nextBtn.disabled = true;
            } else {
                nextBtn.innerHTML = 'ä¸‹ä¸€æ­¥ <i class="bi bi-chevron-right"></i>';
                nextBtn.classList.remove('btn-success');
                nextBtn.classList.add('btn-primary');
                nextBtn.disabled = false;
            }
        }

        // ---------------------- ç•«åœ–åŠŸèƒ½çµæŸ ----------------------

        // ---------------------- [æ–°å¢] å¤–éƒ¨é€£çµåŠŸèƒ½é–‹å§‹ ----------------------

        // ç”¢ç”Ÿå¤–éƒ¨é€£çµå¡ç‰‡çš„ HTML
        function createSimulationCard(url) {
            // ç°¡å–®çš„é˜²å‘†ï¼Œç¢ºä¿æœ‰ URL
            if (!url) return '';

            return `
            <div class="simulation-container mt-3 p-3 border rounded">
                <div class="d-flex align-items-start">
                    <div class="me-3 text-info">
                        <i class="bi bi-laptop fs-1"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="text-dark mb-1">
                            <i class="bi bi-window-stack"></i> äº’å‹•å¼æ¨¡æ“¬å¯¦é©—
                        </h6>
                        <p class="text-muted small mb-2">
                            é€™è£¡æœ‰ä¸€å€‹ç›¸é—œçš„ç¶²é æ¨¡æ“¬ï¼Œå¯ä»¥å¹«åŠ©ä½ æ›´ç›´è§€åœ°ç†è§£é€™å€‹æ¦‚å¿µã€‚
                        </p>
                        <a href="${url}" target="_blank" class="btn btn-sm btn-info text-white">
                            <i class="bi bi-box-arrow-up-right"></i> å‰å¾€é«”é©—
                        </a>
                    </div>
                </div>
            </div>
        `;
        }

        // ---------------------- [æ–°å¢] å¤–éƒ¨é€£çµåŠŸèƒ½çµæŸ ----------------------
    </script>
{% endblock %}