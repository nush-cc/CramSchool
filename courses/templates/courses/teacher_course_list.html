{% extends 'base.html' %}

{% block title %}課程管理 - CramSchool{% endblock %}

{% block page_title %}課程管理{% endblock %}
{% block page_subtitle %}
{% if is_admin %}
管理所有課程
{% else %}
管理您的課程 (共 {{ total_courses }} 門)
{% endif %}
{% endblock %}

{% block content %}
<!-- 搜尋與操作欄 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-8">
                <form method="get" action="{% url 'courses:teacher_course_list' %}" id="filterForm" class="d-flex gap-2">
                    <input type="text" class="form-control" name="search" placeholder="搜尋課程標題或描述..." 
                        value="{{ request.GET.search }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> 搜尋
                    </button>
                    {% if request.GET.search %}
                    <a href="{% url 'courses:teacher_course_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle"></i> 清除
                    </a>
                    {% endif %}
                </form>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'courses:course_create' %}?next=teacher_course_list" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> 新增課程
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 課程列表 -->
{% if courses %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="width: 30%;">課程標題</th>
                <th style="width: 15%;">科目</th>
                <th style="width: 15%;">年級</th>
                <th style="width: 15%;">教師</th>
                <th style="width: 15%;">狀態</th>
                <th style="width: 10%;">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for course in courses %}
            <tr>
                <td>
                    <strong>
                        <a href="{% url 'courses:course_detail' course.pk %}" class="text-decoration-none">
                            {{ course.title }}
                        </a>
                    </strong>
                </td>
                <td>{{ course.subject.name }}</td>
                <td>{{ course.grade.name }}</td>
                <td>
                    {% if course.teacher %}
                        {{ course.teacher.username }}
                    {% else %}
                        <span class="text-muted">未指定</span>
                    {% endif %}
                </td>
                <td>
                    {% if course.is_active %}
                        <span class="badge bg-success">
                            <i class="bi bi-check-circle"></i> 啟用
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="bi bi-x-circle"></i> 停用
                        </span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'courses:course_detail' course.pk %}" 
                            class="btn btn-outline-primary" title="查看">
                            <i class="bi bi-eye"></i>
                        </a>
                        {% if is_admin or course.teacher == user %}
                        <a href="{% url 'courses:course_edit' course.pk %}" 
                            class="btn btn-outline-warning" title="編輯">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" 
                            data-bs-target="#deleteModal{{ course.pk }}" title="刪除">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>

            <!-- 刪除確認模態 -->
            <div class="modal fade" id="deleteModal{{ course.pk }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">確認刪除課程</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p>您確定要刪除課程 <strong>{{ course.title }}</strong> 嗎？</p>
                            <p class="text-danger small">
                                <i class="bi bi-exclamation-triangle"></i>
                                此操作無法撤銷！
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <a href="{% url 'courses:course_delete' course.pk %}" class="btn btn-danger">
                                <i class="bi bi-trash"></i> 確認刪除
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info" role="alert">
    <i class="bi bi-info-circle"></i>
    {% if is_admin %}
        尚無任何課程。<a href="{% url 'courses:course_create' %}">新增課程</a>
    {% else %}
        您還沒有建立任何課程。<a href="{% url 'courses:course_create' %}">新增課程</a>
    {% endif %}
</div>
{% endif %}

<!-- 課程統計 -->
{% if courses %}
<div class="card mt-4 bg-light">
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="display-6 text-primary">{{ total_courses }}</div>
                <div class="text-muted">課程總數</div>
            </div>
            <div class="col-md-4">
                <div class="display-6 text-success">{{ courses|dictsort:"is_active"|length }}</div>
                <div class="text-muted">已啟用課程</div>
            </div>
            <div class="col-md-4">
                <div class="display-6 text-secondary">
                    {% if courses|dictsort:"is_active" %}
                        0
                    {% else %}
                        {{ courses|length }}
                    {% endif %}
                </div>
                <div class="text-muted">已停用課程</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
    .table-hover tbody tr:hover {
        background-color: #f5f5f5;
    }
    
    .btn-group-sm .btn {
        padding: 0.375rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}
