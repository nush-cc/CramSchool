{% extends 'base.html' %}

{% block title %}核准管理 - CramSchool{% endblock %}

{% block page_title %}核准管理{% endblock %}
{% block page_subtitle %}審核學生的選課申請 (待審核: {{ pending_count }} 筆){% endblock %}

{% block content %}
<!-- 統計資訊 -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <h6 class="card-title">待審核</h6>
                <div class="display-4">{{ pending_count }}</div>
            </div>
        </div>
    </div>
</div>

<!-- 待審核申請列表 -->
{% if pending_groups %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-list-check"></i> 待審核申請分組
            </h5>
        </div>
        <div class="card-body">
            {% for group in pending_groups %}
            <div class="row mb-4 pb-4 border-bottom">
                <!-- 申請資訊 -->
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <th style="width: 30%;">學生</th>
                            <td><strong>{{ group.student.username }}</strong></td>
                        </tr>
                        <tr>
                            <th>分組</th>
                            <td>{{ group.grade.name }} - {{ group.subject.name }}</td>
                        </tr>
                        <tr>
                            <th>申請課程</th>
                            <td>{{ group.enrollments|length }} 門</td>
                        </tr>
                    </table>

                    <!-- 申請的課程列表 -->
                    <div class="mt-3">
                        <h6 class="text-muted">申請課程詳情：</h6>
                        <ul class="small">
                            {% for enrollment in group.enrollments %}
                            <li>
                                <strong>{{ enrollment.course.title }}</strong>
                                {% if enrollment.course.grade %}
                                <br>
                                <span class="badge bg-light text-dark">{{ enrollment.course.grade }}</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="col-md-6 d-flex align-items-center">
                    <div class="w-100">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            核准或拒絕此分組會同時影響該分組內的所有課程申請
                        </div>

                        <form method="post" class="d-grid gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="student_id" value="{{ group.student.id }}">
                            <input type="hidden" name="grade_id" value="{{ group.grade.id }}">
                            <input type="hidden" name="subject_id" value="{{ group.subject.id }}">

                            <!-- 核准按鈕 -->
                            <button 
                                type="submit" 
                                name="action" 
                                value="approve" 
                                class="btn btn-success btn-lg"
                                onclick="document.forms[0].action = '{% url 'enrollments:teacher_approve_group' %}';"
                            >
                                <i class="bi bi-check-circle"></i> 核准此分組 ({{ group.enrollments|length }} 門課程)
                            </button>

                            <!-- 拒絕按鈕 -->
                            <button 
                                type="submit" 
                                name="action" 
                                value="reject" 
                                class="btn btn-danger"
                                onclick="if(!confirm('確定要拒絕此分組的所有申請嗎？')) return false; document.forms[0].action = '{% url 'enrollments:teacher_reject_group' %}';"
                            >
                                <i class="bi bi-x-circle"></i> 拒絕此分組
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-circle"></i>
        目前沒有待審核的申請。
    </div>
{% endif %}

<style>
    .display-4 {
        font-weight: 700;
        font-size: 3rem;
    }

    .border-bottom {
        border-bottom: 2px solid #e5e7eb !important;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
</style>
{% endblock %}
